<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bookings - GoPanda Cars</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">
  <!-- Header -->
  <header class="bg-dark sticky-top">
    <nav class="navbar navbar-expand-lg navbar-dark container">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <i class="fas fa-car me-2"></i>
          <h1 class="d-inline m-0">GoPanda Cars</h1>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="profile.html">Profile</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="bookings.html">My Bookings</a>
            </li>
            <li class="nav-item" id="adminNavItem" style="display: none;">
              <a class="nav-link" href="admin.html">Admin</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="loginLink">Login</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="fw-bold">My Bookings</h1>
            <p class="text-muted">Track and manage your car bookings</p>
          </div>
          <a href="index.html" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> New Booking
          </a>
        </div>
      </div>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading your bookings...</p>
    </div>

    <!-- Login Required Section -->
    <div id="loginRequiredSection" style="display: none;" class="text-center py-5">
      <i class="fas fa-user-lock fa-4x text-muted mb-4"></i>
      <h3>Login Required</h3>
      <p class="text-muted mb-4">Please login to view your bookings</p>
      <a href="login.html" class="btn btn-primary btn-lg">
        <i class="fas fa-sign-in-alt me-2"></i> Login
      </a>
    </div>

    <!-- Bookings Section -->
    <div id="bookingsSection" style="display: none;">
      <div class="row" id="bookingsContainer">
        <!-- Bookings will be populated here -->
      </div>
      
      <!-- No Bookings -->
      <div id="noBookingsSection" style="display: none;" class="text-center py-5">
        <i class="fas fa-calendar-times fa-4x text-muted mb-4"></i>
        <h3>No Bookings Found</h3>
        <p class="text-muted mb-4">You haven't made any bookings yet</p>
        <a href="index.html" class="btn btn-primary btn-lg">
          <i class="fas fa-car me-2"></i> Book Your First Car
        </a>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script>
    let userBookings = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthAndLoadBookings();
    });
    
    function checkAuthAndLoadBookings() {
      auth.onAuthStateChanged(async (user) => {
        document.getElementById('loadingSection').style.display = 'none';
        
        if (user) {
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
              currentUser = { uid: user.uid, ...userDoc.data() };
              updateNavigation(true);
              await loadUserBookings(user.uid);
            } else {
              showLoginRequired();
            }
          } catch (error) {
            console.error('Error fetching user data:', error);
            showLoginRequired();
          }
        } else {
          showLoginRequired();
        }
      });
    }
    
    function showLoginRequired() {
      document.getElementById('loginRequiredSection').style.display = 'block';
      updateNavigation(false);
    }
    
    async function loadUserBookings(userId) {
      try {
        const bookingsQuery = db.collection('bookings')
          .where('userId', '==', userId)
          .orderBy('createdAt', 'desc');
        
        const bookingsSnapshot = await bookingsQuery.get();
        userBookings = bookingsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        displayBookings();
        
      } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsSection').style.display = 'block';
        document.getElementById('noBookingsSection').style.display = 'block';
      }
    }
    
    function displayBookings() {
      const bookingsContainer = document.getElementById('bookingsContainer');
      const bookingsSection = document.getElementById('bookingsSection');
      const noBookingsSection = document.getElementById('noBookingsSection');
      
      bookingsSection.style.display = 'block';
      
      if (userBookings.length === 0) {
        noBookingsSection.style.display = 'block';
        return;
      }
      
      bookingsContainer.innerHTML = userBookings.map(createBookingCard).join('');
    }
    
    function createBookingCard(booking) {
      const statusInfo = getStatusInfo(booking.status);
      const createdDate = booking.createdAt ? 
        new Date(booking.createdAt.toDate()).toLocaleDateString('en-IN') : 'N/A';
      
      return `
        <div class="col-lg-6 col-xl-4 mb-4">
          <div class="card h-100 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-bold">${booking.bookingId}</h6>
              <span class="badge ${statusInfo.class}">${statusInfo.text}</span>
            </div>
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <img src="${booking.carImage}" alt="${booking.carName}" 
                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;"
                     onerror="this.onerror=null;this.src='https://images.pexels.com/photos/170811/pexels-photo-170811.jpeg?auto=compress&cs=tinysrgb&w=600'">
                <div>
                  <h6 class="mb-1 fw-bold">${booking.carName}</h6>
                  <small class="text-muted">${booking.rentalOption} rental</small>
                </div>
              </div>
              
              <div class="booking-details">
                <div class="detail-row mb-2">
                  <i class="fas fa-calendar text-primary me-2"></i>
                  <span class="small">${formatDate(booking.startDate)} - ${formatDate(booking.endDate)}</span>
                </div>
                <div class="detail-row mb-2">
                  <i class="fas fa-clock text-primary me-2"></i>
                  <span class="small">${booking.totalDays} days (${booking.totalHours} hours)</span>
                </div>
                <div class="detail-row mb-2">
                  <i class="fas fa-rupee-sign text-success me-2"></i>
                  <span class="small fw-bold">₹${booking.finalPrice}</span>
                  ${booking.discountAmount > 0 ? `<span class="text-success small"> (₹${booking.discountAmount} saved)</span>` : ''}
                </div>
                <div class="detail-row mb-3">
                  <i class="fas fa-calendar-plus text-muted me-2"></i>
                  <span class="small text-muted">Booked on ${createdDate}</span>
                </div>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              ${getActionButtons(booking)}
            </div>
          </div>
        </div>
      `;
    }
    
    function getStatusInfo(status) {
      switch (status) {
        case 'pending_payment':
          return { class: 'bg-warning text-dark', text: 'Pending Payment' };
        case 'payment_submitted':
          return { class: 'bg-info text-white', text: 'Payment Submitted' };
        case 'payment_verified':
          return { class: 'bg-success text-white', text: 'Payment Verified' };
        case 'confirmed':
          return { class: 'bg-success text-white', text: 'Confirmed' };
        case 'active':
          return { class: 'bg-primary text-white', text: 'Active' };
        case 'completed':
          return { class: 'bg-secondary text-white', text: 'Completed' };
        case 'cancelled':
          return { class: 'bg-danger text-white', text: 'Cancelled' };
        default:
          return { class: 'bg-light text-dark', text: status };
      }
    }
    
    function getActionButtons(booking) {
      switch (booking.status) {
        case 'pending_payment':
          return `
            <a href="payment.html?bookingId=${booking.id}" class="btn btn-warning btn-sm w-100">
              <i class="fas fa-credit-card me-1"></i> Complete Payment
            </a>
          `;
        case 'payment_submitted':
          return `
            <button class="btn btn-info btn-sm w-100" disabled>
              <i class="fas fa-clock me-1"></i> Awaiting Verification
            </button>
          `;
        case 'payment_verified':
        case 'confirmed':
          return `
            <button class="btn btn-success btn-sm w-100" disabled>
              <i class="fas fa-check-circle me-1"></i> Booking Confirmed
            </button>
          `;
        case 'active':
          return `
            <button class="btn btn-primary btn-sm w-100" disabled>
              <i class="fas fa-car me-1"></i> Enjoy Your Ride!
            </button>
          `;
        case 'completed':
          return `
            <button class="btn btn-secondary btn-sm w-100" disabled>
              <i class="fas fa-flag-checkered me-1"></i> Trip Completed
            </button>
          `;
        case 'cancelled':
          return `
            <button class="btn btn-danger btn-sm w-100" disabled>
              <i class="fas fa-times-circle me-1"></i> Cancelled
            </button>
          `;
        default:
          return `
            <button class="btn btn-outline-secondary btn-sm w-100" disabled>
              ${booking.status}
            </button>
          `;
      }
    }
    
    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-IN', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }
  </script>
</body>
</html>
